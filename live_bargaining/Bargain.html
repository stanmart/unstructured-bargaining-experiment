{{ block head }}
<link rel="stylesheet" href="{{ static 'live_bargaining.css' }}">
{{ endblock }}

{{ block title }}
Bargaining phase
{{ endblock }}

{{ block content }}

<b> Brief recap of the instructions: </b> 

<div class="side-by-side">
    <div>
        <ul> 
            <li> 
                Any subset of players can form a group, the value of that group is 0 if Player 1 is not in the group. 
                Otherwise, it is increasing in the number of group members according to the graph on the right.
            </li> 
            
            {{ if p5_is_dummy }}
            <li><span class="red-highlight">  Note that in this round, unlike in previous rounds, the group value does not depend on whether Player 5 is in the subgroup or not.</span></li>
            {{ endif }}
            <!-- The line below might be more suitable for the final experiment -->
            <!-- <li style="display: none;" class="dummy-instruction">The shareable group value does not depend on Player 5's inclusion. They can still be included in any allocation.</li> -->
                
            <li> 
                Use the <span class="red-highlight">chat</span> below for bargaining. The other interfaces are additional coordination tools. 
                You can propose as many allocations as you like and change your currently preferred proposal any time. </li>
            <li> 
                You have five minutes to bargain. <b> After the five minutes end, you will not be able to communicate with each other anymore. </b> 
            </li>

            <li> 
                <span class="red-highlight"> Only if <u> all members of a proposed group </u> agree on the same allocation will the bargaining be successful and the proposed allocation be paid out. </span>
                <span class="red-highlight"> Otherwise, everyone gets 0 in this round.</b> </span>
            </li>

        </ul>
        
        <b> This is <span class="red-highlight">round {{ actual_round_number }}</span>. You are <span style="color: #056fb7; font-weight: bold;">Player {{ player.id_in_group }}</span>. 
            
        
        {{ if subsession.round_number == 1 }}
            <p>
                <span class="red-highlight"> Note: This is the trial round. Its outcomes do not count for your final payment.</span>
            </p>
        {{ endif }}
       
    </div>
    <div style="margin-left: 20px;">
        <table id="payoff-table" style="margin-bottom: 30px;">
            <colgroup>
                <col style="width: 50%;">
                <col style="width: 10%">
                <col style="width: 10%">
                <col style="width: 10%">
                <col style="width: 10%">
                <col style="width: 10%">
            </colgroup>
            <tr id="payoff-table-header">
                <th id="payoff-table-header-title">P1 + this many others</th>
            </tr>
            <tr id="payoff-table-values">
                <th>Group's value</th>
            </tr>
        </table>
        <div style="height: 230px; width: 350px">
            <canvas id="payoff-chart"></canvas>
        </div>
    </div>
</div>


<div class="side-by-side" style="height: 500px;">

    <div class="section vertical-fill highlight-section" style="width: 200px;">
        <h3 class="highlight-section-title">Chat</h3>
        {{ chat nickname=player.role }} 
    </div>
    
    <div class="section vertical-fill">
        <h3>Past proposals</h4>
        <div class="vertical-fill" style="overflow-y: auto;">
            <table class="offer-table horizontal-rules shaded-rows">
                <thead>
                    <tr>
                        <th class="offer-id-col">ID</th>
                        <th class="offer-proposer-col">From</th>
                        <th class="offer-player-col player-1">P1</th>
                        <th class="offer-player-col player-2">P2</th>
                        <th class="offer-player-col player-3">P3</th>
                        <th class="offer-player-col player-4">P4</th>
                        <th class="offer-player-col player-5">P5</th>
                    </tr>
                </thead>
                <tbody id="past-offers-table"></tbody>
            </table>
        </div>
    </div>
        
</div>


<div class="section dim-section">
    <h3>Propose allocation</h2>    
    <table class="offer-table">
        <tbody>
            <tr>
                <th></th>
                <th class="offer-player-col player-1">Player 1</th>
                <th class="offer-player-col player-2">Player 2</th>
                <th class="offer-player-col player-3">Player 3</th>
                <th class="offer-player-col player-4">Player 4</th>
                <th class="offer-player-col player-5">Player 5</th>
                <th style="text-align: right;">Total</th>
            </tr>
            <tr style="height: 3em;">
                <th class="offer-left-col">In group</th>
                <td class="offer-player-col"><input type="checkbox" class="coalition-member" id="is-member-1"></td>
                <td class="offer-player-col"><input type="checkbox" class="coalition-member" id="is-member-2"></td>
                <td class="offer-player-col"><input type="checkbox" class="coalition-member" id="is-member-3"></td>
                <td class="offer-player-col"><input type="checkbox" class="coalition-member" id="is-member-4"></td>
                <td class="offer-player-col"><input type="checkbox" class="coalition-member" id="is-member-5"></td>
                <td class="offer-total-col"><div class="allocation-total" id="total-shareable">0</div></td>
            </tr>
            <tr style="height: 3em;">
                <th class="offer-left-col">Allocation</th>
                <td class="offer-player-col"><input type="number" disabled="true", value="0", class="allocation" id="allocation-1"></td>
                <td class="offer-player-col"><input type="number" disabled="true", value="0", class="allocation" id="allocation-2"></td>
                <td class="offer-player-col"><input type="number" disabled="true", value="0", class="allocation" id="allocation-3"></td>
                <td class="offer-player-col"><input type="number" disabled="true", value="0", class="allocation" id="allocation-4"></td>
                <td class="offer-player-col"><input type="number" disabled="true", value="0", class="allocation" id="allocation-5"></td>
                <td class="offer-total-col"><div class="allocation-total" id="total-shared">0</div></td>
            </tr>
        </tbody>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td style="text-align: right;"><button type="button" onclick="sendOffer()" id="btn-propose" style="width: 100%">Submit</button></td>
        </tr>
    </table>
</div>

<div class="section">
    <h3>Currently preferred proposal</h2>    
    <table class="offer-table">
        <tbody>
            <tr>
                <th></th>
                <th class="offer-player-col player-1">Player 1</th>
                <th class="offer-player-col player-2">Player 2</th>
                <th class="offer-player-col player-3">Player 3</th>
                <th class="offer-player-col player-4">Player 4</th>
                <th class="offer-player-col player-5">Player 5</th>
            </tr>
            <tr style="height: 3em;">
                <th class="offer-left-col">Preferred proposal <span class="red-highlight">ID</span></th>
                <td class="offer-player-col" id="accepted-1" class="allocation">—</td>
                <td class="offer-player-col" id="accepted-2" class="allocation">—</td>
                <td class="offer-player-col" id="accepted-3" class="allocation">—</td>
                <td class="offer-player-col" id="accepted-4" class="allocation">—</td>
                <td class="offer-player-col" id="accepted-5" class="allocation">—</td>
            </tr>
            <tr style="height: 3em;">
                <th class="offer-left-col">Implied payment</th>
                <td class="offer-player-col" class="payoff" id="payoff-1">0</td>
                <td class="offer-player-col" class="payoff" id="payoff-2">0</td>
                <td class="offer-player-col" class="payoff" id="payoff-3">0</td>
                <td class="offer-player-col" class="payoff" id="payoff-4">0</td>
                <td class="offer-player-col" class="payoff" id="payoff-5">0</td>
            </tr>
        </tbody>
    </table>
    <div class="side-by-side">
        <div class="flex-item" style="margin-top: 20px; font-weight: bold;">Choose preferred proposal <span class="red-highlight">(ID)</span>:</div>
        <select id="offer-select" class="flex-item", style="margin: 20px;">
            <option disabled selected></option>
        </select>
        <button type="button" onclick="sendAccept()" id="btn-accept" class="flex-item", style="margin: 20px;">Submit preferred</button>
        <button type="button" onclick="sendRevert()" id="btn-revert" class="flex-item", style="margin: 20px;">Clear preferred</button>
    </div>
</div>

<div id="popup-full">
    <div id="popup" class="section">
        <h3 id="popup-title">Warning</h3>
        <p id="popup-content"></p>
        <button type="button" onclick="closePopup()" id="btn-close-popup">Close</button>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ static 'live_bargaining.js' }}"></script>

{{ endblock }}
