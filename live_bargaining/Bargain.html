{{ block head }}
<link rel="stylesheet" href="{{ static 'live_bargaining.css' }}">
{{ endblock }}

{{ block title }}
Bargaining phase
{{ endblock }}

{{ block content }}

<b> This is <span style="color: #b70505;">round {{ actual_round_number }}</span>. Instructions Recap: </b> </p>

<div class="side-by-side">
    <div>
        <p>
            This is a 5-player game.
            Any subset of players can form a coalition.
            The value the coalition produces depends on its members:
            <ul>
                <li>If Player 1 is not in the coalition, the value is 0.</li>
                <li>Otherwise, it is increasing in the number of members (see table and graph on the right).</li>
                {{ if p5_is_dummy }}
                <li><span style="color: #b70505; font-weight: bold;">  Note that in this round, unlike in previous rounds, the coalition value does not depend on whether Player 5 is in the coalition or not.</span></li>
                {{ endif }}
                <!-- The line below might be more suitable for the final experiment -->
                <!-- <li style="display: none;" class="dummy-instruction">The shareable coalition value does not depend on Player 5's inclusion. They can still be included in any allocation.</li> -->
            </ul>
        </p>
        <p>
            You bargain with the other players via the <span style="color: #b70505; font-weight: bold;">chat</span>. 
            The proposal interface ("Proposed allocations" and "Currently preferred proposal") is an additional coordination tool and helps you see what offers are on the table.
            You can propose as many allocations as you like, and change your preferred proposal at any time. 
            You can only submit positive integer values as allocations.
            The other players will see your proposed allocations and your currently preferred proposal.
        </p>
        <p>
            You are <span style="color: #056fb7; font-weight: bold;">Player {{ player.id_in_group }}</span>. Please negotiate with the other players in the chat below.
        </p>

        {{ if subsession.round_number == 1 }}
            <p>
                <span style="color: #b70505; font-weight: bold;"> Note: This is the trial round. Its payoffs do not count for your final payoffs.</span>
            </p>
        {{ endif }}
       
    </div>
    <div style="margin-left: 20px;">
        <table id="payoff-table" style="margin-bottom: 30px;">
            <colgroup>
                <col style="width: 50%;">
                <col style="width: 10%">
                <col style="width: 10%">
                <col style="width: 10%">
                <col style="width: 10%">
                <col style="width: 10%">
            </colgroup>
            <tr id="payoff-table-header">
                <th id="payoff-table-header-title">P1 + this many others</th>
            </tr>
            <tr id="payoff-table-values">
                <th>Coalition's payoff</th>
            </tr>
        </table>
        <div style="height: 230px; width: 350px">
            <canvas id="payoff-chart"></canvas>
        </div>
    </div>
</div>


<div class="side-by-side" style="height: 500px;">

    <div class="section flex-item vertical-fill highlight-section">
        <h3 class="highlight-section-title">Chat</h3>
        {{ chat nickname=player.role }} 
    </div>
    
    <div class="section flex-item vertical-fill">
        <h3>Past proposals</h4>
        <div class="flex-item vertical-fill" style="overflow-y: auto;">
            <table class="offer-table horizontal-rules">
                <thead>
                    <tr>
                        <th class="offer-left-col">From</th>
                        <th class="offer-id-col">ID</th>
                        <th class="offer-player-col player-1">P1</th>
                        <th class="offer-player-col player-2">P2</th>
                        <th class="offer-player-col player-3">P3</th>
                        <th class="offer-player-col player-4">P4</th>
                        <th class="offer-player-col player-5">P5</th>
                    </tr>
                </thead>
                <tbody id="past-offers-table"></tbody>
            </table>
        </div>
    </div>
        
</div>


<div class="section dim-section">
    <h3>Propose allocation</h2>    
    <table class="offer-table">
        <tbody>
            <tr>
                <th></th>
                <th class="offer-player-col player-1">Player 1</th>
                <th class="offer-player-col player-2">Player 2</th>
                <th class="offer-player-col player-3">Player 3</th>
                <th class="offer-player-col player-4">Player 4</th>
                <th class="offer-player-col player-5">Player 5</th>
                <th style="text-align: right;">Total</th>
            </tr>
            <tr style="height: 3em;">
                <th class="offer-left-col">In coalition</th>
                <td class="offer-player-col"><input type="checkbox" class="coalition-member" id="is-member-1"></td>
                <td class="offer-player-col"><input type="checkbox" class="coalition-member" id="is-member-2"></td>
                <td class="offer-player-col"><input type="checkbox" class="coalition-member" id="is-member-3"></td>
                <td class="offer-player-col"><input type="checkbox" class="coalition-member" id="is-member-4"></td>
                <td class="offer-player-col"><input type="checkbox" class="coalition-member" id="is-member-5"></td>
                <td class="offer-total-col"><div class="allocation-total" id="total-shareable">0</div></td>
            </tr>
            <tr style="height: 3em;">
                <th class="offer-left-col">Allocation</th>
                <td class="offer-player-col"><input type="number" disabled="true", value="0", class="allocation" id="allocation-1"></td>
                <td class="offer-player-col"><input type="number" disabled="true", value="0", class="allocation" id="allocation-2"></td>
                <td class="offer-player-col"><input type="number" disabled="true", value="0", class="allocation" id="allocation-3"></td>
                <td class="offer-player-col"><input type="number" disabled="true", value="0", class="allocation" id="allocation-4"></td>
                <td class="offer-player-col"><input type="number" disabled="true", value="0", class="allocation" id="allocation-5"></td>
                <td class="offer-total-col"><div class="allocation-total" id="total-shared">0</div></td>
            </tr>
        </tbody>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td style="text-align: right;"><button type="button" onclick="sendOffer()" id="btn-propose" style="width: 100%">Submit</button></td>
        </tr>
    </table>
</div>

<div class="section">
    <h3>Currently preferred proposal</h2>    
    <table class="offer-table">
        <tbody>
            <tr>
                <th></th>
                <th class="offer-player-col player-1">Player 1</th>
                <th class="offer-player-col player-2">Player 2</th>
                <th class="offer-player-col player-3">Player 3</th>
                <th class="offer-player-col player-4">Player 4</th>
                <th class="offer-player-col player-5">Player 5</th>
            </tr>
            <tr style="height: 3em;">
                <th class="offer-left-col">Preferred proposal ID</th>
                <td class="offer-player-col" id="accepted-1" class="allocation">—</td>
                <td class="offer-player-col" id="accepted-2" class="allocation">—</td>
                <td class="offer-player-col" id="accepted-3" class="allocation">—</td>
                <td class="offer-player-col" id="accepted-4" class="allocation">—</td>
                <td class="offer-player-col" id="accepted-5" class="allocation">—</td>
            </tr>
            <tr style="height: 3em;">
                <th class="offer-left-col">Implied payoff</th>
                <td class="offer-player-col" class="payoff" id="payoff-1">0</td>
                <td class="offer-player-col" class="payoff" id="payoff-2">0</td>
                <td class="offer-player-col" class="payoff" id="payoff-3">0</td>
                <td class="offer-player-col" class="payoff" id="payoff-4">0</td>
                <td class="offer-player-col" class="payoff" id="payoff-5">0</td>
            </tr>
        </tbody>
    </table>
    <div class="side-by-side">
        <div class="flex-item" style="margin-top: 20px; font-weight: bold;">Choose preferred proposal (ID):</div>
        <select id="offer-select" class="flex-item", style="margin: 20px;"></select>
        <button type="button" onclick="sendAccept()" id="btn-accept" class="flex-item", style="margin: 20px;">Submit preferred</button>
        <button type="button" onclick="sendRevert()" id="btn-revert" class="flex-item", style="margin: 20px;">Clear preferred</button>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ static 'live_bargaining.js' }}"></script>

{{ endblock }}
